#!/bin/bash
# Post-removal script for ssi-agent

set -e

# Only run cleanup on complete removal (not upgrade)
if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
    echo "Cleaning up ssi-agent..."

    # Ask about removing data directories
    if [ -d "/var/log/ssi-agent" ]; then
        echo ""
        echo "Remove log directory (/var/log/ssi-agent) containing service logs?"
        echo -n "[y/N]: "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            rm -rf /var/log/ssi-agent
            echo "Log directory removed."
        else
            echo "Log directory kept at /var/log/ssi-agent"
        fi
    fi

    # Ask about removing config directory
    if [ -d "/etc/ssi-agent" ]; then
        echo ""
        echo "Remove configuration directory (/etc/ssi-agent)?"
        echo -n "[y/N]: "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            rm -rf /etc/ssi-agent
            echo "Configuration directory removed."
        else
            echo "Configuration directory kept at /etc/ssi-agent"
        fi
    fi

    # Remove system user if no other files owned by it
    if id -u ssi-agent >/dev/null 2>&1; then
        USER_FILES=$(find / -user ssi-agent 2>/dev/null | wc -l)
        if [ "$USER_FILES" -le 1 ]; then
            userdel ssi-agent
            echo "System user 'ssi-agent' removed."
        else
            echo "Keeping system user 'ssi-agent' (other files still owned by it)."
        fi
    fi

    # Remove application directory
    if [ -d "/opt/ssi-agent" ]; then
        rm -rf /opt/ssi-agent
        echo "Application directory removed."
    fi

    echo "Cleanup completed."
fi
