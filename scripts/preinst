#!/bin/bash
# Pre-installation script for ssi-agent

set -e

# Check system requirements before installation
echo "Checking system requirements..."

# Check if running on Linux
if [[ "$OSTYPE" != "linux-gnu"* ]]; then
    echo "ERROR: This package is designed for Linux systems only"
    exit 1
fi

# Check for systemd
if ! command -v systemctl &> /dev/null; then
    echo "ERROR: systemd is required but not found"
    echo "This package requires a systemd-based Linux distribution"
    exit 1
fi

# Check if systemd is the active init system
if [[ ! -d /run/systemd/system ]]; then
    echo "ERROR: systemd does not appear to be the active init system"
    exit 1
fi

# Check for Python 3
if ! command -v python3 &> /dev/null; then
    echo "ERROR: Python 3 is required but not found"
    exit 1
fi

# Check Python version (minimum 3.9)
PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))' 2>/dev/null || echo "0.0")
if ! python3 -c 'import sys; sys.exit(0 if sys.version_info >= (3, 9) else 1)' 2>/dev/null; then
    echo "ERROR: Python 3.9 or higher is required. Found: Python $PYTHON_VERSION"
    exit 1
fi

# Check for python3-venv
if ! python3 -c 'import venv' 2>/dev/null; then
    echo "ERROR: python3-venv is required but not available"
    exit 1
fi

echo "System requirements check passed âœ“"
