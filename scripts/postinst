#!/bin/bash
# Post-installation script for ssi-agent

set -e

# Create system user if it doesn't exist
if ! id -u ssi-agent >/dev/null 2>&1; then
    useradd --system --shell /bin/false --home-dir /opt/ssi-agent --create-home ssi-agent
fi

# Create log directory
mkdir -p /var/log/ssi-agent
chown ssi-agent:ssi-agent /var/log/ssi-agent
chmod 755 /var/log/ssi-agent

# Create config directory
mkdir -p /etc/ssi-agent
chown ssi-agent:ssi-agent /etc/ssi-agent
chmod 755 /etc/ssi-agent

# Reload systemd daemon
systemctl daemon-reload

# Enable and start service (only if this is an initial install, not upgrade)
if [ "$1" = "configure" ] && [ -z "$2" ]; then
    systemctl enable ssi-agent
    systemctl start ssi-agent
fi

echo "Service Status Indicator Agent installed successfully!"
echo ""
echo "Next steps:"
echo "1. Register the agent: ssi-agent register <agent-key>"
echo "2. Check service status: systemctl status ssi-agent"
echo "3. View logs: journalctl -u ssi-agent -f"
echo ""
echo "Configuration file: /etc/ssi-agent/config.json"
echo "Log directory: /var/log/ssi-agent"
